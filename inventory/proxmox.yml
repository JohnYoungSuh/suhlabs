---
# Ansible Inventory for Proxmox k3s Cluster
# Auto-generated by: terraform output ansible_inventory > inventory/proxmox.yml

all:
  vars:
    # SSH Configuration
    ansible_user: cloud-user
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    ansible_python_interpreter: /usr/bin/python3
    
    # k3s Configuration
    k3s_version: v1.28.5+k3s1
    k3s_token: "{{ lookup('env', 'K3S_TOKEN') | default('change-me-in-production', true) }}"
    
    # Network Configuration
    cluster_cidr: 10.42.0.0/16
    service_cidr: 10.43.0.0/16
    cluster_dns: 10.43.0.10
    
    # Feature Flags
    k3s_disable:
      - traefik  # We'll use our own ingress
      - servicelb  # We'll use MetalLB
    
    k3s_server_args:
      - "--write-kubeconfig-mode=644"
      - "--disable-cloud-controller"
      - "--tls-san={{ lb_vip }}"
      - "--tls-san={{ ansible_host }}"
    
    k3s_agent_args:
      - "--node-label=node-role=worker"
    
    # Vault Configuration
    vault_addr: "http://vault.corp.example.com:8200"
    vault_token: "{{ lookup('env', 'VAULT_TOKEN') }}"

  children:
    k3s_cluster:
      children:
        control_plane:
          hosts:
            k3s-cp-01:
              ansible_host: 10.100.0.10
              node_ip: 10.100.0.10
              node_name: k3s-cp-01
              k3s_role: server
              k3s_server_init: true  # First node initializes cluster
            
            k3s-cp-02:
              ansible_host: 10.100.0.11
              node_ip: 10.100.0.11
              node_name: k3s-cp-02
              k3s_role: server
              k3s_server_init: false
            
            k3s-cp-03:
              ansible_host: 10.100.0.12
              node_ip: 10.100.0.12
              node_name: k3s-cp-03
              k3s_role: server
              k3s_server_init: false
        
        workers:
          hosts:
            k3s-worker-01:
              ansible_host: 10.100.0.20
              node_ip: 10.100.0.20
              node_name: k3s-worker-01
              k3s_role: agent
              asg_group: base
            
            k3s-worker-02:
              ansible_host: 10.100.0.21
              node_ip: 10.100.0.21
              node_name: k3s-worker-02
              k3s_role: agent
              asg_group: base
            
            k3s-worker-03:
              ansible_host: 10.100.0.22
              node_ip: 10.100.0.22
              node_name: k3s-worker-03
              k3s_role: agent
              asg_group: base
            
            # Autoscaling group workers (started on-demand)
            k3s-worker-asg-01:
              ansible_host: 10.100.0.23
              node_ip: 10.100.0.23
              node_name: k3s-worker-asg-01
              k3s_role: agent
              asg_group: dynamic
            
            k3s-worker-asg-02:
              ansible_host: 10.100.0.24
              node_ip: 10.100.0.24
              node_name: k3s-worker-asg-02
              k3s_role: agent
              asg_group: dynamic
            
            k3s-worker-asg-03:
              ansible_host: 10.100.0.25
              node_ip: 10.100.0.25
              node_name: k3s-worker-asg-03
              k3s_role: agent
              asg_group: dynamic
    
    loadbalancers:
      vars:
        lb_vip: 10.100.0.5
        lb_port: 6443
        lb_backend_port: 6443
        keepalived_priority_master: 100
        keepalived_priority_backup: 90
        keepalived_router_id: 51
        keepalived_interface: eth0
        keepalived_auth_pass: "{{ lookup('env', 'KEEPALIVED_PASSWORD') | default('change-me', true) }}"
      
      hosts:
        lb-01:
          ansible_host: 10.100.0.6
          keepalived_state: MASTER
          keepalived_priority: "{{ keepalived_priority_master }}"
        
        lb-02:
          ansible_host: 10.100.0.7
          keepalived_state: BACKUP
          keepalived_priority: "{{ keepalived_priority_backup }}"
    
    bastion:
      hosts:
        bastion-01:
          ansible_host: 10.100.0.254
          bastion_external_ip: "{{ lookup('env', 'BASTION_EXTERNAL_IP') }}"

    # Infrastructure Services
    dns_servers:
      vars:
        dns_domain: corp.example.com
        dns_server_type: master
      hosts:
        dns-01:
          ansible_host: 10.100.0.50
          dns_server_type: master

        dns-02:
          ansible_host: 10.100.0.51
          dns_server_type: slave
          dns_master_ip: 10.100.0.50

    freeipa_servers:
      vars:
        freeipa_domain: corp.example.com
        freeipa_realm: CORP.EXAMPLE.COM
      hosts:
        ipa-01:
          ansible_host: 10.100.0.60
          freeipa_hostname: ipa
