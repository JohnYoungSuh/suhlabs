---
# AIOps Substrate - Main Site Playbook
# Orchestrates full cluster deployment

- name: Deploy HAProxy Load Balancers
  hosts: loadbalancers
  become: yes
  roles:
    - haproxy
  tags: [loadbalancer, haproxy]

- name: Deploy k3s Control Plane
  hosts: control_plane
  become: yes
  serial: 1  # Deploy one at a time for stability
  roles:
    - k3s
  tags: [k3s, control-plane]

- name: Deploy k3s Worker Nodes
  hosts: workers
  become: yes
  roles:
    - k3s
  tags: [k3s, workers]

- name: Post-deployment verification
  hosts: k3s-cp-01
  become: yes
  tasks:
    - name: Wait for all nodes to be ready
      command: kubectl get nodes
      register: nodes_status
      until: nodes_status.stdout.find('NotReady') == -1
      retries: 30
      delay: 10
      changed_when: false
    
    - name: Display cluster status
      command: kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false
    
    - name: Show cluster info
      debug:
        var: cluster_nodes.stdout_lines
    
    - name: Display cluster pods
      command: kubectl get pods -A
      register: cluster_pods
      changed_when: false
    
    - name: Show pods
      debug:
        var: cluster_pods.stdout_lines
  tags: [verify]
