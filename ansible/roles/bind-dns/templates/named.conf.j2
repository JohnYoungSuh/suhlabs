// BIND Configuration for {{ dns_domain }}
// Generated by Ansible

options {
    listen-on port 53 { any; };
    listen-on-v6 port 53 { any; };
    directory "/var/named";
    dump-file "/var/named/data/cache_dump.db";
    statistics-file "/var/named/data/named_stats.txt";
    memstatistics-file "/var/named/data/named_mem_stats.txt";
    secroots-file "/var/named/data/named.secroots";
    recursing-file "/var/named/data/named.recursing";
    
    allow-query { {{ dns_allow_query | join('; ') }}; };
    allow-transfer { {{ dns_allow_transfer | join('; ') }}; };
    
    recursion yes;
    
    forwarders {
{% for forwarder in dns_forwarders %}
        {{ forwarder }};
{% endfor %}
    };
    
    dnssec-validation {{ 'yes' if dns_enable_dnssec else 'no' }};
    
    managed-keys-directory "/var/named/dynamic";
    pid-file "/run/named/named.pid";
    session-keyfile "/run/named/session.key";
    
    include "/etc/crypto-policies/back-ends/bind.config";
};

logging {
    channel default_debug {
        file "data/named.run";
        severity dynamic;
    };
};

// Root hints
zone "." IN {
    type hint;
    file "named.ca";
};

// Forward zone
zone "{{ dns_domain }}" IN {
    type {{ dns_server_type }};
{% if dns_server_type == 'master' %}
    file "zones/master/db.{{ dns_domain }}";
    allow-update { none; };
{% else %}
    file "zones/slave/db.{{ dns_domain }}";
    masters { {{ dns_master_ip }}; };
{% endif %}
};

// Reverse zone
zone "{{ dns_reverse_zone }}" IN {
    type {{ dns_server_type }};
{% if dns_server_type == 'master' %}
    file "zones/master/db.{{ dns_reverse_zone }}";
    allow-update { none; };
{% else %}
    file "zones/slave/db.{{ dns_reverse_zone }}";
    masters { {{ dns_master_ip }}; };
{% endif %}
};

{% if dns_enable_dynamic_updates %}
// Dynamic zone for k3s
zone "{{ dns_dynamic_zone }}" IN {
    type master;
    file "dynamic/db.{{ dns_dynamic_zone }}";
    allow-update { localhost; };  // Allow local updates only
};
{% endif %}

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
