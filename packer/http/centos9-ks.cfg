# CentOS Stream 9 Kickstart for Proxmox Template
# Automated installation with cloud-init support

# Installation method
text
cdrom

# Language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network configuration (will be overridden by cloud-init)
network --bootproto=dhcp --device=eth0 --onboot=yes --noipv6

# Root password (will be disabled, SSH key only via cloud-init)
rootpw --lock
user --name=cloud-user --password=packer --plaintext --groups=wheel

# SELinux
selinux --enforcing

# Firewall
firewall --enabled --service=ssh

# Bootloader
bootloader --location=mbr --boot-drive=sda
zerombr
clearpart --all --initlabel

# Disk partitioning (LVM for flexibility)
part /boot/efi --fstype=efi --size=512 --ondisk=sda
part /boot --fstype=xfs --size=1024 --ondisk=sda
part pv.01 --size=1 --grow --ondisk=sda

volgroup vg_root pv.01
logvol / --fstype=xfs --name=lv_root --vgname=vg_root --size=40960 --grow
logvol swap --fstype=swap --name=lv_swap --vgname=vg_root --size=2048

# Services
services --enabled=chronyd,qemu-guest-agent,cloud-init,cloud-init-local,cloud-config,cloud-final

# Packages
%packages
@core
@standard
cloud-init
cloud-utils-growpart
qemu-guest-agent
chrony
vim
curl
wget
git
net-tools
bind-utils
python3
python3-pip
yum-utils
device-mapper-persistent-data
lvm2
-NetworkManager-wifi
-aic94xx-firmware
-alsa-firmware
-ivtv-firmware
-iwl*-firmware
%end

# Post-installation script
%post --log=/root/ks-post.log

# Enable cloud-init
systemctl enable cloud-init-local.service
systemctl enable cloud-init.service
systemctl enable cloud-config.service
systemctl enable cloud-final.service

# Enable QEMU guest agent
systemctl enable qemu-guest-agent

# Configure cloud-init datasource
cat > /etc/cloud/cloud.cfg.d/99_proxmox.cfg <<EOF
datasource_list: [NoCloud, ConfigDrive]
EOF

# Allow cloud-user sudo without password
echo "cloud-user ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/cloud-user
chmod 0440 /etc/sudoers.d/cloud-user

# SSH configuration
sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/^#PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# Disable root password
passwd -l root

# Configure chrony NTP
cat > /etc/chrony.conf <<EOF
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst
driftfile /var/lib/chrony/drift
makestep 1.0 3
rtcsync
EOF

%end

# Reboot after installation
reboot --eject
