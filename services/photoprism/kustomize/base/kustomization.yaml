apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base PhotoPrism deployment - multi-tenant template
# Use overlays to customize per family

namespace: photoprism-FAMILY_NAME

namePrefix: FAMILY_NAME-

commonLabels:
  app: photoprism
  family: FAMILY_NAME
  managed-by: ai-ops-agent
  project: suhlabs

resources:
  - namespace.yaml
  - storage.yaml
  - minio.yaml
  - mariadb.yaml
  - photoprism.yaml
  - ingress.yaml
  - monitoring.yaml

# ConfigMap generator for family-specific configuration
configMapGenerator:
  - name: photoprism-config
    literals:
      - FAMILY_NAME=FAMILY_NAME
      - PREFERRED_NAME=PREFERRED_NAME
      - PHOTOPRISM_SITE_URL=https://photos.FAMILY_NAME.family
      - PHOTOPRISM_SITE_TITLE=PREFERRED_NAME Photos

# Secret generator for family-specific secrets (placeholder - use Vault in production)
secretGenerator:
  - name: photoprism-secrets
    literals:
      - FAMILY_NAME=FAMILY_NAME

# Replacements for variable substitution
replacements:
  - source:
      kind: ConfigMap
      name: photoprism-config
      fieldPath: data.FAMILY_NAME
    targets:
      - select:
          kind: Namespace
        fieldPaths:
          - metadata.name
      - select:
          kind: Ingress
        fieldPaths:
          - spec.rules.*.host
          - spec.tls.*.hosts.*

# Images to use (can be overridden in overlays)
images:
  - name: photoprism
    newName: photoprism/photoprism
    newTag: latest
  - name: minio
    newName: minio/minio
    newTag: RELEASE.2024-01-16T16-07-38Z
  - name: mariadb
    newName: mariadb
    newTag: "10.11"

# Common annotations
commonAnnotations:
  managed-by: "ai-ops-agent"
  deployed-by: "photoprism-onboarding"
