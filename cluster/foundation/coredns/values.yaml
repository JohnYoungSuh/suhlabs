# ============================================================================
# CoreDNS Helm Values
# Foundation DNS Service for Kubernetes
# ============================================================================

# Required Helm metadata (applied to all resources including ConfigMap)
customLabels:
  app.kubernetes.io/managed-by: Helm

customAnnotations:
  meta.helm.sh/release-name: coredns
  meta.helm.sh/release-namespace: kube-system

# Service configuration
service:
  name: coredns
  # clusterIP: 10.96.0.10  # Omitted to preserve existing Service IP during Helm adoption

# Resource limits (good for dev)
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 50m
    memory: 64Mi

# Replicas for HA
replicaCount: 2

# CoreDNS server configuration
servers:
  # Cluster DNS (standard K8s)
  - zones:
      - zone: .
    port: 53
    plugins:
      # Error logging
      - name: errors

      # Health checks
      - name: health
        configBlock: |-
          lameduck 5s

      # Readiness check
      - name: ready

      # Kubernetes service discovery
      - name: kubernetes
        parameters: cluster.local in-addr.arpa ip6.arpa
        configBlock: |-
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
          ttl 30

      # Prometheus metrics
      - name: prometheus
        parameters: 0.0.0.0:9153

      # Forward to upstream DNS
      - name: forward
        parameters: . /etc/resolv.conf
        configBlock: |-
          except cluster.local

      # Caching
      - name: cache
        parameters: 30

      # Loop detection
      - name: loop

      # Reload config automatically
      - name: reload

      # Load balance responses
      - name: loadbalance

  # Custom corp.local zone
  - zones:
      - zone: corp.local
    port: 53
    plugins:
      - name: errors
      - name: file
        parameters: /etc/coredns/corp.local.db
      - name: log

# Custom zone files
zoneFiles:
  - filename: corp.local.db
    domain: corp.local
    contents: |
      $ORIGIN corp.local.
      @   IN  SOA ns1.corp.local. admin.corp.local. (
              2024111201  ; Serial
              7200        ; Refresh
              3600        ; Retry
              1209600     ; Expire
              3600 )      ; Negative Cache TTL

      ; Name servers
      @   IN  NS  ns1.corp.local.
      ns1 IN  A   10.96.0.10

      ; Kubernetes services
      kubernetes      IN  A   10.96.0.1

      ; Vault service
      vault           IN  CNAME vault.vault.svc.cluster.local.

      ; AI Ops Agent
      ai-ops          IN  CNAME ai-ops-agent.ai-ops.svc.cluster.local.

      ; Wildcard for *.corp.local â†’ ingress
      *               IN  A   10.0.1.100

# Prometheus ServiceMonitor
serviceMonitor:
  enabled: false  # Enable when Prometheus is deployed

# Security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    add:
      - NET_BIND_SERVICE
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Autoscaling (optional)
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
