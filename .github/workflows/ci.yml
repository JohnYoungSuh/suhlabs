name: CI Pipeline

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  KIND_VERSION: v0.20.0
  KUBECTL_VERSION: v1.28.0
  HELM_VERSION: v3.13.0
  VAULT_VERSION: 1.15.0

jobs:
  # ============================================================================
  # Linting and Validation
  # ============================================================================
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive || true
        working-directory: infra

      - name: Terraform Validate
        run: |
          cd infra/local
          terraform init -backend=false
          terraform validate
        continue-on-error: true

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: cluster/
          config_file: .yamllint.yml
          strict: false
        continue-on-error: true

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './cluster'
        continue-on-error: true

  # ============================================================================
  # Build Docker Images
  # ============================================================================
  build:
    name: Build Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: prepare repository name (lowercase for docker)
        id: repo
        run: echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Extract metadata for AI Ops Agent
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/ai-ops-agent
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push AI Ops Agent
        id: push
        uses: docker/build-push-action@v5
        with:
          context: cluster/ai-ops-agent
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: false

      - name: Generate artifact attestation
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/ai-ops-agent
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  # ============================================================================
  # Infrastructure Tests
  # ============================================================================
  test-infrastructure:
    name: Test Foundation Services
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          version: ${{ env.KIND_VERSION }}
          kubectl_version: ${{ env.KUBECTL_VERSION }}
          cluster_name: aiops-test
          config: bootstrap/kind-cluster.yaml
          wait: 2m

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Vault CLI
        run: |
          wget -q https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip
          unzip vault_${VAULT_VERSION}_linux_amd64.zip
          sudo mv vault /usr/local/bin/
          vault version

      - name: Deploy CoreDNS
        run: |
          cd cluster/foundation/coredns
          chmod +x deploy.sh
          ./deploy.sh
          sleep 10
          kubectl get pods -n kube-system -l k8s-app=kube-dns

      - name: Test CoreDNS - Cluster DNS
        run: |
          kubectl run dns-test --image=busybox:1.36 --rm -i --restart=Never -- \
            nslookup kubernetes.default.svc.cluster.local || true

      - name: Test CoreDNS - Custom Zone
        run: |
          kubectl run dns-corp-test --image=busybox:1.36 --rm -i --restart=Never -- \
            nslookup ns1.corp.local || true

      - name: Deploy Vault with SoftHSM
        run: |
          cd cluster/foundation/vault
          chmod +x deploy.sh
          ./deploy.sh
          sleep 30
          kubectl get pods -n vault

      - name: Initialize Vault
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=vault -n vault --timeout=120s || true
          sleep 10
          # Port forward to Vault
          if ! pgrep -f "port-forward.*vault.*8200" > /dev/null; then
            kubectl port-forward -n vault svc/vault 8200:8200 &
            sleep 5
          fi
          export VAULT_ADDR=http://localhost:8200

          # Initialize Vault if not already initialized
          if ! vault status 2>/dev/null | grep -q "Initialized.*true"; then
            vault operator init -key-shares=1 -key-threshold=1 > vault-keys.txt || true
            echo "âœ“ Vault initialized (keys saved to vault-keys.txt)"
            echo "Note: Keys are NOT printed to logs for security"
          fi

      - name: Unseal Vault
        run: |
          export VAULT_ADDR=http://localhost:8200

          # Restart port-forward if needed
          if ! pgrep -f "port-forward.*vault.*8200" > /dev/null; then
            kubectl port-forward -n vault svc/vault 8200:8200 &
            sleep 5
          fi

          # Extract unseal keys and unseal Vault
          if [ -f vault-keys.txt ]; then
            echo "Unsealing Vault with all available keys..."

            # Extract and apply each unseal key
            # Since we initialized with -key-shares=1 -key-threshold=1, only one key is needed
            # But we'll handle multiple keys in case the configuration changes
            for i in 1 2 3 4 5; do
              UNSEAL_KEY=$(grep "Unseal Key $i:" vault-keys.txt 2>/dev/null | awk '{print $NF}')
              if [ -n "$UNSEAL_KEY" ]; then
                echo "Applying unseal key $i..."
                vault operator unseal "$UNSEAL_KEY" || true
              fi
            done

            # Verify Vault is unsealed
            echo ""
            echo "Vault status after unsealing:"
            vault status
          else
            echo "Warning: vault-keys.txt not found, Vault may already be unsealed"
            vault status || true
          fi

      - name: Deploy Vault PKI
        run: |
          # Ensure port-forward is running
          if ! pgrep -f "port-forward.*vault.*8200" > /dev/null; then
            kubectl port-forward -n vault svc/vault 8200:8200 &
            sleep 5
          fi

          cd cluster/foundation/vault-pki
          chmod +x init-vault-pki.sh verify-pki.sh

          # Get vault token from initialization
          if [ -f /home/runner/work/suhlabs/suhlabs/vault-keys.txt ]; then
            export VAULT_TOKEN=$(grep 'Initial Root Token:' /home/runner/work/suhlabs/suhlabs/vault-keys.txt | awk '{print $NF}')
          else
            export VAULT_TOKEN=root
          fi

          export VAULT_ADDR=http://localhost:8200
          ./init-vault-pki.sh || true
          sleep 5

      - name: Verify PKI
        run: |
          # Ensure port-forward is running
          if ! pgrep -f "port-forward.*vault.*8200" > /dev/null; then
            kubectl port-forward -n vault svc/vault 8200:8200 &
            sleep 5
          fi

          cd cluster/foundation/vault-pki
          if [ -f /home/runner/work/suhlabs/suhlabs/vault-keys.txt ]; then
            export VAULT_TOKEN=$(grep 'Initial Root Token:' /home/runner/work/suhlabs/suhlabs/vault-keys.txt | awk '{print $NF}')
          else
            export VAULT_TOKEN=root
          fi
          export VAULT_ADDR=http://localhost:8200
          ./verify-pki.sh || true

      - name: Deploy cert-manager
        run: |
          cd cluster/foundation/cert-manager
          chmod +x deploy.sh

          if [ -f /home/runner/work/suhlabs/suhlabs/vault-keys.txt ]; then
            export VAULT_TOKEN=$(grep 'Initial Root Token:' /home/runner/work/suhlabs/suhlabs/vault-keys.txt | awk '{print $NF}')
          else
            export VAULT_TOKEN=root
          fi

          ./deploy.sh
          sleep 20
          kubectl get pods -n cert-manager

      - name: Verify cert-manager
        run: |
          cd cluster/foundation/cert-manager
          chmod +x verify-cert-manager.sh
          ./verify-cert-manager.sh || true

      - name: Run comprehensive verification
        run: |
          # Ensure port-forward is running
          if ! pgrep -f "port-forward.*vault.*8200" > /dev/null; then
            kubectl port-forward -n vault svc/vault 8200:8200 &
            sleep 5
          fi

          cd cluster/foundation
          chmod +x verify-all.sh

          if [ -f /home/runner/work/suhlabs/suhlabs/vault-keys.txt ]; then
            export VAULT_TOKEN=$(grep 'Initial Root Token:' /home/runner/work/suhlabs/suhlabs/vault-keys.txt | awk '{print $NF}')
          fi
          export VAULT_ADDR=http://localhost:8200

          ./verify-all.sh || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            cluster/foundation/**/*.log
          retention-days: 7

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== CoreDNS Logs ==="
          kubectl logs -n kube-system -l k8s-app=kube-dns --tail=100 || true
          echo "=== Vault Logs ==="
          kubectl logs -n vault -l app.kubernetes.io/name=vault --tail=100 || true
          echo "=== cert-manager Logs ==="
          kubectl logs -n cert-manager -l app=cert-manager --tail=100 || true
          echo "=== All Pods ==="
          kubectl get pods -A

  # ============================================================================
  # Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-infrastructure]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          version: ${{ env.KIND_VERSION }}
          kubectl_version: ${{ env.KUBECTL_VERSION }}
          cluster_name: aiops-integration
          config: bootstrap/kind-cluster.yaml

      - name: Run full stack deployment
        run: |
          echo "Full integration test would go here"
          echo "Testing end-to-end certificate issuance and renewal"
          # This would deploy the full stack and test interactions

  # ============================================================================
  # Status Check
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, build, test-infrastructure]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" = "failure" ] || \
             [ "${{ needs.build.result }}" = "failure" ] || \
             [ "${{ needs.test-infrastructure.result }}" = "failure" ]; then
            echo "CI pipeline failed"
            exit 1
          fi
          echo "CI pipeline successful!"
